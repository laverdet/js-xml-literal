NODE_PREFIX := $(shell node --vars | egrep ^NODE_PREFIX: | cut -c14-)
LIBFBJS = ../external/libfbjs
LIBFBJS_A = $(LIBFBJS)/libfbjs.a
CPPFLAGS = -ggdb -Wall -DNOT_FBMAKE=1 -I$(LIBFBJS)/.. -I$(NODE_PREFIX)/include -I$(NODE_PREFIX)/include/node

all: e4x-bump.node

$(LIBFBJS_A):
	cd $(LIBFBJS); make

%.o: %.cpp
	$(CXX) $(CPPFLAGS) -c -o $@ $<

# desugar.o needs libfbjs.a to be built /first/ because it uses headers
# generated by that make.
desugar.o: $(LIBFBJS_A)

cli: cli.o desugar.o $(LIBFBJS_A)
	$(CXX) $(CPPFLAGS) -o $@ $^

e4x-bump.node: e4x-bump.o desugar.o $(LIBFBJS_A)
	$(CXX) $(CPPFLAGS) -bundle -undefined dynamic_lookup -o $@ $^

clean:
	-$(RM) cli.o desugar.o e4x-bump.o cli e4x-bump.node
	cd $(LIBFBJS); make clean
