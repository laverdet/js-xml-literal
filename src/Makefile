NODE_PREFIX := $(shell node --vars | egrep ^NODE_PREFIX: | cut -c14-)
LIBFBJS = ../external/libfbjs
LIBFBJS_A = $(LIBFBJS)/libfbjs.a
CPPFLAGS = -fPIC -ggdb -Wall -DNOT_FBMAKE=1 -I$(LIBFBJS)/.. -I$(NODE_PREFIX)/include -I$(NODE_PREFIX)/include/node

all: js-xml-literal.node

$(LIBFBJS_A):
	cd $(LIBFBJS); make

%.o: %.cpp
	$(CXX) $(CPPFLAGS) -c -o $@ $<

# desugar.o needs libfbjs.a to be built /first/ because it uses headers
# generated by that make.
desugar.o: $(LIBFBJS_A)

cli: cli.o desugar.o $(LIBFBJS_A)
	$(CXX) $(CPPFLAGS) -o $@ $^

js-xml-literal.node: js-xml-literal.o desugar.o $(LIBFBJS_A)
	$(CXX) $(CPPFLAGS) -fPIC -shared -Wl,-Bdynamic -o $@ $^

clean:
	-$(RM) cli.o desugar.o js-xml-literal.o cli js-xml-literal.node
	cd $(LIBFBJS); make clean
